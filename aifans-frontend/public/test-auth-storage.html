<!DOCTYPE html>
<html>
<head>
    <title>测试认证存储和API调用</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        pre {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>测试认证存储和API调用</h1>
    
    <div id="auth-status" class="section"></div>
    <div id="api-test" class="section"></div>
    
    <div style="margin-top: 20px;">
        <button onclick="testAPICall()">测试影院API调用</button>
        <button onclick="testWithToken()">使用Token测试</button>
        <button onclick="window.location.href='http://localhost:3000/login'">前往登录</button>
    </div>
    
    <script>
        // 检查认证状态
        function checkAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            let html = '<h3>认证状态检查</h3>';
            
            // 检查localStorage
            const authStorage = localStorage.getItem('auth-storage');
            if (authStorage) {
                try {
                    const authData = JSON.parse(authStorage);
                    if (authData.state && authData.state.token) {
                        html += '<p class="success">✅ 找到认证Token</p>';
                        html += `<p>Token前缀: ${authData.state.token.substring(0, 20)}...</p>`;
                        html += `<p>用户: ${authData.state.user?.username || '未知'}</p>`;
                        window.authToken = authData.state.token;
                    } else {
                        html += '<p class="warning">⚠️ 认证数据不完整</p>';
                    }
                } catch (e) {
                    html += '<p class="error">❌ 解析认证数据失败</p>';
                }
            } else {
                html += '<p class="warning">⚠️ 未找到认证数据，请先登录</p>';
            }
            
            // 检查cookies
            html += '<h4>Cookies:</h4>';
            html += '<pre>' + (document.cookie || '(无cookies)') + '</pre>';
            
            statusDiv.innerHTML = html;
        }
        
        // 测试API调用
        async function testAPICall() {
            const testDiv = document.getElementById('api-test');
            let html = '<h3>API调用测试</h3>';
            
            try {
                // 1. 测试基本调用
                html += '<h4>1. 基本调用 (credentials: include)</h4>';
                const response1 = await fetch('/api/screenings', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                html += `<p>状态码: ${response1.status}</p>`;
                if (response1.ok) {
                    const data = await response1.json();
                    html += '<p class="success">✅ 调用成功</p>';
                    html += `<p>影片数量: ${data.screenings?.length || 0}</p>`;
                } else {
                    const error = await response1.json();
                    html += `<p class="error">❌ 调用失败: ${error.message}</p>`;
                }
                
            } catch (error) {
                html += `<p class="error">❌ 请求异常: ${error.message}</p>`;
            }
            
            testDiv.innerHTML = html;
        }
        
        // 使用Token测试
        async function testWithToken() {
            const testDiv = document.getElementById('api-test');
            let html = '<h3>使用Token测试API</h3>';
            
            if (!window.authToken) {
                html += '<p class="error">❌ 未找到Token，请先登录</p>';
                testDiv.innerHTML = html;
                return;
            }
            
            try {
                // 使用Authorization header
                html += '<h4>使用Authorization Header</h4>';
                const response = await fetch('/api/screenings', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.authToken}`
                    }
                });
                
                html += `<p>状态码: ${response.status}</p>`;
                if (response.ok) {
                    const data = await response.json();
                    html += '<p class="success">✅ 调用成功</p>';
                    html += `<p>影片数量: ${data.screenings?.length || 0}</p>`;
                    if (data.screenings && data.screenings.length > 0) {
                        html += '<h5>第一个影片:</h5>';
                        html += '<pre>' + JSON.stringify(data.screenings[0], null, 2) + '</pre>';
                    }
                } else {
                    const error = await response.json();
                    html += `<p class="error">❌ 调用失败: ${error.message}</p>`;
                }
                
            } catch (error) {
                html += `<p class="error">❌ 请求异常: ${error.message}</p>`;
            }
            
            testDiv.innerHTML = html;
        }
        
        // 页面加载时检查状态
        checkAuthStatus();
    </script>
</body>
</html> 
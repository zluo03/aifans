<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶é¡µé¢è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-good { color: #28a745; background-color: #d4edda; }
        .status-warning { color: #856404; background-color: #fff3cd; }
        .status-error { color: #721c24; background-color: #f8d7da; }
        .status-info { color: #0c5460; background-color: #d1ecf1; }
        .status-box {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid;
        }
        .log-entry {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .test-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .test-links a {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .test-links a:hover {
            background-color: #218838;
        }
        .real-time-log {
            max-height: 400px;
            overflow-y: auto;
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å®æ—¶é¡µé¢è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-panel">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€ç›‘æ§</h2>
        <button onclick="startMonitoring()">å¼€å§‹ç›‘æ§</button>
        <button onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        <div id="current-status"></div>
    </div>

    <div class="debug-panel">
        <h2>ğŸ”— æµ‹è¯•é“¾æ¥</h2>
        <div class="test-links">
            <a href="/resources" target="_blank">èµ„æºåˆ—è¡¨</a>
            <a href="/resources/1" target="_blank">èµ„æºè¯¦æƒ…(ID:1)</a>
            <a href="/resources/2" target="_blank">èµ„æºè¯¦æƒ…(ID:2)</a>
            <a href="/resources/3" target="_blank">èµ„æºè¯¦æƒ…(ID:3)</a>
        </div>
        <p><small>ç‚¹å‡»é“¾æ¥åœ¨æ–°æ ‡ç­¾é¡µä¸­æµ‹è¯•ï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºå’Œé¡µé¢è¡Œä¸º</small></p>
    </div>

    <div class="debug-panel">
        <h2>ğŸ“ å®æ—¶æ—¥å¿—</h2>
        <div id="real-time-log" class="real-time-log"></div>
    </div>

    <div class="debug-panel">
        <h2>ğŸ§ª æ‰‹åŠ¨æµ‹è¯•</h2>
        <button onclick="testResourceAccess()">æµ‹è¯•èµ„æºè®¿é—®æµç¨‹</button>
        <button onclick="testAuthState()">æµ‹è¯•è®¤è¯çŠ¶æ€</button>
        <button onclick="simulatePageNavigation()">æ¨¡æ‹Ÿé¡µé¢å¯¼èˆª</button>
        <div id="manual-test-results"></div>
    </div>

    <script>
        let monitoringInterval = null;
        let logBuffer = [];

        // é‡å†™console.logæ¥æ•è·æ—¥å¿—
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToRealTime('LOG', args);
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToRealTime('ERROR', args);
        };

        function logToRealTime(type, args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logBuffer.push(`[${timestamp}] [${type}] ${message}`);
            if (logBuffer.length > 100) {
                logBuffer = logBuffer.slice(-100);
            }
            updateRealTimeLog();
        }

        function updateRealTimeLog() {
            const logDiv = document.getElementById('real-time-log');
            logDiv.innerHTML = logBuffer.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLogs() {
            logBuffer = [];
            updateRealTimeLog();
        }

        function addResult(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `status-box status-${type}`;
            resultDiv.innerHTML = content;
            container.appendChild(resultDiv);
        }

        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            console.log('å¼€å§‹å®æ—¶ç›‘æ§é¡µé¢çŠ¶æ€...');
            
            monitoringInterval = setInterval(() => {
                const authStorage = localStorage.getItem('auth-storage');
                let status = 'æœªç™»å½•';
                let role = 'N/A';
                let isAuthenticated = false;
                let token = null;

                if (authStorage) {
                    try {
                        const parsed = JSON.parse(authStorage);
                        const state = parsed.state || parsed;
                        if (state.user) {
                            status = 'å·²ç™»å½•';
                            role = state.user.role;
                            isAuthenticated = state.isAuthenticated;
                            token = state.token;
                        }
                    } catch (e) {
                        status = 'è§£æé”™è¯¯';
                    }
                }

                const timestamp = new Date().toLocaleTimeString();
                const statusHtml = `
                    <div class="status-box status-info">
                        <strong>å®æ—¶çŠ¶æ€ç›‘æ§</strong> (${timestamp})<br>
                        ç™»å½•çŠ¶æ€: ${status}<br>
                        è®¤è¯çŠ¶æ€: ${isAuthenticated ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}<br>
                        ç”¨æˆ·è§’è‰²: ${role}<br>
                        TokençŠ¶æ€: ${token ? 'æœ‰æ•ˆ' : 'æ— '}<br>
                        å½“å‰é¡µé¢: ${window.location.pathname}
                    </div>
                `;

                const container = document.getElementById('current-status');
                container.innerHTML = statusHtml;
            }, 2000);
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            console.log('åœæ­¢å®æ—¶ç›‘æ§');
        }

        async function testResourceAccess() {
            console.log('=== å¼€å§‹æµ‹è¯•èµ„æºè®¿é—®æµç¨‹ ===');
            
            // 1. æ£€æŸ¥è®¤è¯çŠ¶æ€
            const authStorage = localStorage.getItem('auth-storage');
            if (!authStorage) {
                addResult('manual-test-results', 'âŒ æœªæ‰¾åˆ°è®¤è¯å­˜å‚¨', 'error');
                return;
            }

            const parsed = JSON.parse(authStorage);
            const state = parsed.state || parsed;
            const user = state.user;
            const token = state.token;

            console.log('ç”¨æˆ·ä¿¡æ¯:', user);
            console.log('Token:', token ? token.substring(0, 20) + '...' : 'none');

            if (!user) {
                addResult('manual-test-results', 'âŒ ç”¨æˆ·å¯¹è±¡ä¸å­˜åœ¨', 'error');
                return;
            }

            if (user.role === 'NORMAL') {
                addResult('manual-test-results', 'âš ï¸ æ™®é€šç”¨æˆ·ï¼Œåº”è¯¥è¢«é˜»æ­¢è®¿é—®', 'warning');
                return;
            }

            addResult('manual-test-results', `âœ… ç”¨æˆ·æƒé™æ£€æŸ¥é€šè¿‡ (${user.role})`, 'good');

            // 2. æµ‹è¯•APIè°ƒç”¨
            try {
                console.log('æµ‹è¯•èµ„æºåˆ—è¡¨API...');
                const listResponse = await fetch('/api/resources?limit=1', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!listResponse.ok) {
                    throw new Error(`èµ„æºåˆ—è¡¨APIå¤±è´¥: ${listResponse.status}`);
                }

                const listData = await listResponse.json();
                console.log('èµ„æºåˆ—è¡¨APIæˆåŠŸ:', listData);

                if (listData.resources && listData.resources.length > 0) {
                    const resourceId = listData.resources[0].id;
                    
                    console.log(`æµ‹è¯•èµ„æºè¯¦æƒ…API (ID: ${resourceId})...`);
                    const detailResponse = await fetch(`/api/resources/${resourceId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!detailResponse.ok) {
                        throw new Error(`èµ„æºè¯¦æƒ…APIå¤±è´¥: ${detailResponse.status}`);
                    }

                    const detailData = await detailResponse.json();
                    console.log('èµ„æºè¯¦æƒ…APIæˆåŠŸ:', detailData);
                    
                    addResult('manual-test-results', `âœ… APIæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œèµ„æº: ${detailData.title}`, 'good');
                } else {
                    addResult('manual-test-results', 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•èµ„æº', 'warning');
                }
            } catch (error) {
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
                addResult('manual-test-results', `âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAuthState() {
            console.log('=== æµ‹è¯•è®¤è¯çŠ¶æ€ ===');
            
            const authStorage = localStorage.getItem('auth-storage');
            if (!authStorage) {
                addResult('manual-test-results', 'âŒ è®¤è¯å­˜å‚¨ä¸å­˜åœ¨', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(authStorage);
                const state = parsed.state || parsed;
                
                console.log('å®Œæ•´è®¤è¯çŠ¶æ€:', state);
                
                addResult('manual-test-results', `
                    <strong>è®¤è¯çŠ¶æ€è¯¦æƒ…:</strong><br>
                    ç”¨æˆ·ID: ${state.user?.id || 'N/A'}<br>
                    ç”¨æˆ·å: ${state.user?.username || 'N/A'}<br>
                    æ˜µç§°: ${state.user?.nickname || 'N/A'}<br>
                    è§’è‰²: ${state.user?.role || 'N/A'}<br>
                    çŠ¶æ€: ${state.user?.status || 'N/A'}<br>
                    è®¤è¯çŠ¶æ€: ${state.isAuthenticated ? 'æ˜¯' : 'å¦'}<br>
                    Tokené•¿åº¦: ${state.token ? state.token.length : 0}
                `, 'info');
            } catch (error) {
                console.error('è§£æè®¤è¯çŠ¶æ€å¤±è´¥:', error);
                addResult('manual-test-results', `âŒ è§£æè®¤è¯çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulatePageNavigation() {
            console.log('=== æ¨¡æ‹Ÿé¡µé¢å¯¼èˆª ===');
            
            // æ¨¡æ‹Ÿç‚¹å‡»èµ„æºå¡ç‰‡çš„é€»è¾‘
            const authStorage = localStorage.getItem('auth-storage');
            if (!authStorage) {
                addResult('manual-test-results', 'âŒ æœªç™»å½•ï¼Œæ— æ³•å¯¼èˆª', 'error');
                return;
            }

            const parsed = JSON.parse(authStorage);
            const user = (parsed.state || parsed).user;

            if (!user) {
                addResult('manual-test-results', 'âŒ ç”¨æˆ·å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•å¯¼èˆª', 'error');
                return;
            }

            if (user.role === 'NORMAL') {
                addResult('manual-test-results', 'âš ï¸ æ™®é€šç”¨æˆ·ï¼Œåº”è¯¥æ˜¾ç¤ºå‡çº§æç¤º', 'warning');
                return;
            }

            addResult('manual-test-results', `âœ… å¯¼èˆªæƒé™æ£€æŸ¥é€šè¿‡ï¼Œç”¨æˆ·è§’è‰²: ${user.role}`, 'good');
            
            // æ¨¡æ‹Ÿå¯¼èˆªåˆ°èµ„æºè¯¦æƒ…é¡µé¢
            console.log('æ¨¡æ‹Ÿå¯¼èˆªåˆ°èµ„æºè¯¦æƒ…é¡µé¢...');
            addResult('manual-test-results', 'ğŸ”„ æ¨¡æ‹Ÿå¯¼èˆªæˆåŠŸï¼Œåº”è¯¥èƒ½å¤Ÿè®¿é—®èµ„æºè¯¦æƒ…', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹ç›‘æ§
        window.addEventListener('load', () => {
            console.log('é¡µé¢è°ƒè¯•å·¥å…·åŠ è½½å®Œæˆ');
            startMonitoring();
        });

        // é¡µé¢å¸è½½æ—¶åœæ­¢ç›‘æ§
        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html> 
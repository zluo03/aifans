<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ„æºè®¿é—®é—®é¢˜æœ€ç»ˆè°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-good { color: #28a745; background-color: #d4edda; }
        .status-warning { color: #856404; background-color: #fff3cd; }
        .status-error { color: #721c24; background-color: #f8d7da; }
        .status-info { color: #0c5460; background-color: #d1ecf1; }
        .status-box {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid;
        }
        .code-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin: 10px 0;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .step-counter {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-right: 10px;
        }
        .test-result {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .console-log {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” èµ„æºè®¿é—®é—®é¢˜æœ€ç»ˆè°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-panel">
        <h2>ğŸ“‹ é—®é¢˜è¯Šæ–­æ¸…å•</h2>
        <div class="status-box status-info">
            <strong>é—®é¢˜æè¿°ï¼š</strong>ç»ˆèº«ä¼šå‘˜ç”¨æˆ·æ— æ³•è®¿é—®èµ„æºè¯¦æƒ…é¡µé¢
        </div>
        <div class="status-box status-warning">
            <strong>é¢„æœŸè¡Œä¸ºï¼š</strong>LIFETIMEè§’è‰²ç”¨æˆ·åº”è¯¥èƒ½å¤Ÿæ­£å¸¸è®¿é—®èµ„æºè¯¦æƒ…
        </div>
    </div>

    <div class="debug-panel">
        <h2>ğŸ”§ è‡ªåŠ¨è¯Šæ–­</h2>
        <button onclick="runFullDiagnosis()">å¼€å§‹å®Œæ•´è¯Šæ–­</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        <div id="diagnosis-results"></div>
    </div>

    <div class="debug-panel">
        <h2>ğŸ‘¤ ç”¨æˆ·çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkUserState()">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</button>
        <button onclick="checkAuthStorage()">æ£€æŸ¥è®¤è¯å­˜å‚¨</button>
        <button onclick="testPermissionLogic()">æµ‹è¯•æƒé™é€»è¾‘</button>
        <div id="user-state-results"></div>
    </div>

    <div class="debug-panel">
        <h2>ğŸŒ APIæµ‹è¯•</h2>
        <button onclick="testResourceListAPI()">æµ‹è¯•èµ„æºåˆ—è¡¨API</button>
        <button onclick="testResourceDetailAPI()">æµ‹è¯•èµ„æºè¯¦æƒ…API</button>
        <button onclick="testUserProfileAPI()">æµ‹è¯•ç”¨æˆ·èµ„æ–™API</button>
        <div id="api-test-results"></div>
    </div>

    <div class="debug-panel">
        <h2>ğŸ”„ å®æ—¶ç›‘æ§</h2>
        <button onclick="startRealTimeMonitoring()">å¼€å§‹å®æ—¶ç›‘æ§</button>
        <button onclick="stopRealTimeMonitoring()">åœæ­¢ç›‘æ§</button>
        <div id="monitoring-results"></div>
    </div>

    <div class="debug-panel">
        <h2>ğŸ“ æ§åˆ¶å°æ—¥å¿—</h2>
        <button onclick="clearConsoleLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="console-log" class="console-log"></div>
    </div>

    <script>
        let monitoringInterval = null;
        let consoleLogBuffer = [];

        // é‡å†™console.logæ¥æ•è·æ—¥å¿—
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleLogBuffer.push(`[${timestamp}] ${message}`);
            updateConsoleDisplay();
        };

        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-log');
            consoleDiv.innerHTML = consoleLogBuffer.slice(-50).join('\n');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function clearConsoleLog() {
            consoleLogBuffer = [];
            updateConsoleDisplay();
        }

        function addResult(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result status-${type}`;
            resultDiv.innerHTML = content;
            container.appendChild(resultDiv);
        }

        function clearResults() {
            const containers = ['diagnosis-results', 'user-state-results', 'api-test-results', 'monitoring-results'];
            containers.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        async function runFullDiagnosis() {
            console.log('=== å¼€å§‹å®Œæ•´è¯Šæ–­ ===');
            clearResults();
            
            addResult('diagnosis-results', '<span class="step-counter">1</span>æ£€æŸ¥æœ¬åœ°å­˜å‚¨...', 'info');
            await checkAuthStorage();
            
            addResult('diagnosis-results', '<span class="step-counter">2</span>æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...', 'info');
            await checkUserState();
            
            addResult('diagnosis-results', '<span class="step-counter">3</span>æµ‹è¯•æƒé™é€»è¾‘...', 'info');
            await testPermissionLogic();
            
            addResult('diagnosis-results', '<span class="step-counter">4</span>æµ‹è¯•APIè®¿é—®...', 'info');
            await testResourceListAPI();
            await testUserProfileAPI();
            
            addResult('diagnosis-results', '<span class="step-counter">5</span>è¯Šæ–­å®Œæˆï¼è¯·æŸ¥çœ‹å„éƒ¨åˆ†çš„è¯¦ç»†ç»“æœã€‚', 'good');
        }

        function checkAuthStorage() {
            console.log('æ£€æŸ¥è®¤è¯å­˜å‚¨...');
            try {
                const authStorage = localStorage.getItem('auth-storage');
                if (!authStorage) {
                    addResult('user-state-results', 'âŒ æœªæ‰¾åˆ°è®¤è¯å­˜å‚¨æ•°æ®', 'error');
                    return;
                }

                const parsed = JSON.parse(authStorage);
                const state = parsed.state || parsed;
                
                console.log('è®¤è¯å­˜å‚¨æ•°æ®:', state);
                
                let html = '<h4>ğŸ“¦ è®¤è¯å­˜å‚¨åˆ†æ</h4>';
                html += `<div class="code-display">å­˜å‚¨ç»“æ„: ${JSON.stringify(state, null, 2)}</div>`;
                
                if (state.user) {
                    const user = state.user;
                    html += `<div class="status-box status-good">
                        âœ… ç”¨æˆ·æ•°æ®å­˜åœ¨<br>
                        ID: ${user.id}<br>
                        ç”¨æˆ·å: ${user.username || 'N/A'}<br>
                        æ˜µç§°: ${user.nickname || 'N/A'}<br>
                        è§’è‰²: <strong>${user.role}</strong><br>
                        çŠ¶æ€: ${user.status || 'N/A'}<br>
                        è®¤è¯çŠ¶æ€: ${state.isAuthenticated ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}
                    </div>`;
                    
                    if (user.role === 'LIFETIME') {
                        html += '<div class="status-box status-good">âœ… ç¡®è®¤ï¼šç”¨æˆ·è§’è‰²ä¸ºLIFETIMEï¼Œåº”è¯¥æœ‰è®¿é—®æƒé™</div>';
                    } else if (user.role === 'NORMAL') {
                        html += '<div class="status-box status-warning">âš ï¸ ç”¨æˆ·è§’è‰²ä¸ºNORMALï¼Œæ— æ³•è®¿é—®èµ„æºè¯¦æƒ…</div>';
                    } else {
                        html += `<div class="status-box status-info">â„¹ï¸ ç”¨æˆ·è§’è‰²ä¸º${user.role}</div>`;
                    }
                } else {
                    html += '<div class="status-box status-error">âŒ ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨</div>';
                }
                
                if (state.token) {
                    html += `<div class="status-box status-good">âœ… Tokenå­˜åœ¨: ${state.token.substring(0, 20)}...</div>`;
                } else {
                    html += '<div class="status-box status-error">âŒ Tokenä¸å­˜åœ¨</div>';
                }
                
                addResult('user-state-results', html, 'info');
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯å­˜å‚¨å¤±è´¥:', error);
                addResult('user-state-results', `âŒ æ£€æŸ¥è®¤è¯å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function checkUserState() {
            console.log('æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...');
            try {
                const authStorage = localStorage.getItem('auth-storage');
                if (!authStorage) {
                    addResult('user-state-results', 'âŒ æ— æ³•æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼šè®¤è¯å­˜å‚¨ä¸å­˜åœ¨', 'error');
                    return;
                }

                const parsed = JSON.parse(authStorage);
                const state = parsed.state || parsed;
                const user = state.user;
                
                let html = '<h4>ğŸ‘¤ ç”¨æˆ·çŠ¶æ€åˆ†æ</h4>';
                
                if (!user) {
                    html += '<div class="status-box status-error">âŒ ç”¨æˆ·å¯¹è±¡ä¸å­˜åœ¨</div>';
                    addResult('user-state-results', html, 'error');
                    return;
                }
                
                // æ¨¡æ‹Ÿèµ„æºè¯¦æƒ…é¡µé¢çš„æƒé™æ£€æŸ¥
                html += '<div class="status-box status-info">ğŸ” æ¨¡æ‹Ÿèµ„æºè¯¦æƒ…é¡µé¢æƒé™æ£€æŸ¥ï¼š</div>';
                
                const authLoading = false; // å‡è®¾å·²åŠ è½½å®Œæˆ
                const isAuthenticated = state.isAuthenticated;
                
                html += `<div class="code-display">è®¤è¯çŠ¶æ€æ£€æŸ¥:
authLoading: ${authLoading}
isAuthenticated: ${isAuthenticated}
user: ${user ? 'exists' : 'null'}
user.role: ${user?.role || 'N/A'}</div>`;
                
                // æ­¥éª¤1ï¼šæ£€æŸ¥è®¤è¯åŠ è½½çŠ¶æ€
                if (authLoading) {
                    html += '<div class="status-box status-warning">â³ è®¤è¯çŠ¶æ€åŠ è½½ä¸­...</div>';
                } else {
                    html += '<div class="status-box status-good">âœ… è®¤è¯çŠ¶æ€å·²åŠ è½½</div>';
                }
                
                // æ­¥éª¤2ï¼šæ£€æŸ¥æ˜¯å¦è®¤è¯
                if (!isAuthenticated) {
                    html += '<div class="status-box status-error">âŒ ç”¨æˆ·æœªè®¤è¯ï¼Œä¼šè·³è½¬åˆ°ç™»å½•é¡µé¢</div>';
                } else {
                    html += '<div class="status-box status-good">âœ… ç”¨æˆ·å·²è®¤è¯</div>';
                }
                
                // æ­¥éª¤3ï¼šæ£€æŸ¥ç”¨æˆ·å¯¹è±¡
                if (!user) {
                    html += '<div class="status-box status-warning">âš ï¸ ç”¨æˆ·å¯¹è±¡ä¸å­˜åœ¨ï¼Œä¼šç­‰å¾…ç”¨æˆ·æ•°æ®åŠ è½½</div>';
                } else {
                    html += '<div class="status-box status-good">âœ… ç”¨æˆ·å¯¹è±¡å­˜åœ¨</div>';
                }
                
                // æ­¥éª¤4ï¼šæ£€æŸ¥ç”¨æˆ·è§’è‰²
                if (user && user.role === 'NORMAL') {
                    html += '<div class="status-box status-error">âŒ æ™®é€šç”¨æˆ·ï¼Œä¼šè¢«æ‹’ç»è®¿é—®å¹¶è·³è½¬</div>';
                } else if (user && ['PREMIUM', 'LIFETIME', 'ADMIN'].includes(user.role)) {
                    html += '<div class="status-box status-good">âœ… æœ‰æƒé™çš„ç”¨æˆ·ï¼Œå¯ä»¥è®¿é—®èµ„æºè¯¦æƒ…</div>';
                } else {
                    html += `<div class="status-box status-warning">âš ï¸ æœªçŸ¥è§’è‰²: ${user?.role}</div>`;
                }
                
                // æœ€ç»ˆç»“è®º
                if (isAuthenticated && user && user.role !== 'NORMAL') {
                    html += '<div class="status-box status-good"><strong>ğŸ‰ ç»“è®ºï¼šç”¨æˆ·åº”è¯¥èƒ½å¤Ÿè®¿é—®èµ„æºè¯¦æƒ…é¡µé¢</strong></div>';
                } else {
                    html += '<div class="status-box status-error"><strong>ğŸš« ç»“è®ºï¼šç”¨æˆ·æ— æ³•è®¿é—®èµ„æºè¯¦æƒ…é¡µé¢</strong></div>';
                }
                
                addResult('user-state-results', html, 'info');
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                addResult('user-state-results', `âŒ æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testPermissionLogic() {
            console.log('æµ‹è¯•æƒé™é€»è¾‘...');
            
            const testCases = [
                { user: null, expected: false, reason: 'æœªç™»å½•' },
                { user: { role: 'NORMAL' }, expected: false, reason: 'æ™®é€šç”¨æˆ·' },
                { user: { role: 'PREMIUM' }, expected: true, reason: 'é«˜çº§ä¼šå‘˜' },
                { user: { role: 'LIFETIME' }, expected: true, reason: 'ç»ˆèº«ä¼šå‘˜' },
                { user: { role: 'ADMIN' }, expected: true, reason: 'ç®¡ç†å‘˜' }
            ];
            
            let html = '<h4>ğŸ§ª æƒé™é€»è¾‘æµ‹è¯•</h4>';
            
            testCases.forEach((testCase, index) => {
                const user = testCase.user;
                const isAuthenticated = !!user;
                
                // æ¨¡æ‹Ÿæƒé™æ£€æŸ¥é€»è¾‘
                let result = false;
                let reason = '';
                
                if (!isAuthenticated) {
                    reason = 'ç”¨æˆ·æœªè®¤è¯';
                } else if (!user) {
                    reason = 'ç”¨æˆ·å¯¹è±¡ä¸å­˜åœ¨';
                } else if (user.role === 'NORMAL') {
                    reason = 'æ™®é€šç”¨æˆ·æ— æƒé™';
                } else {
                    result = true;
                    reason = 'æœ‰æƒé™è®¿é—®';
                }
                
                const statusClass = result === testCase.expected ? 'status-good' : 'status-error';
                const statusIcon = result === testCase.expected ? 'âœ…' : 'âŒ';
                
                html += `<div class="status-box ${statusClass}">
                    ${statusIcon} æµ‹è¯• ${index + 1}: ${testCase.reason}<br>
                    è¾“å…¥: ${user ? `role="${user.role}"` : 'null'}<br>
                    é¢„æœŸ: ${testCase.expected ? 'å…è®¸' : 'æ‹’ç»'}<br>
                    å®é™…: ${result ? 'å…è®¸' : 'æ‹’ç»'} (${reason})<br>
                    ç»“æœ: ${result === testCase.expected ? 'é€šè¿‡' : 'å¤±è´¥'}
                </div>`;
            });
            
            addResult('user-state-results', html, 'info');
        }

        async function testResourceListAPI() {
            console.log('æµ‹è¯•èµ„æºåˆ—è¡¨API...');
            try {
                const authStorage = localStorage.getItem('auth-storage');
                if (!authStorage) {
                    addResult('api-test-results', 'âŒ æ— æ³•æµ‹è¯•APIï¼šè®¤è¯å­˜å‚¨ä¸å­˜åœ¨', 'error');
                    return;
                }

                const parsed = JSON.parse(authStorage);
                const token = (parsed.state || parsed).token;
                
                if (!token) {
                    addResult('api-test-results', 'âŒ æ— æ³•æµ‹è¯•APIï¼šTokenä¸å­˜åœ¨', 'error');
                    return;
                }

                const response = await fetch('/api/resources?limit=1', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let html = '<h4>ğŸ“‹ èµ„æºåˆ—è¡¨APIæµ‹è¯•</h4>';
                html += `<div class="code-display">è¯·æ±‚URL: /api/resources?limit=1
å“åº”çŠ¶æ€: ${response.status}
å“åº”çŠ¶æ€æ–‡æœ¬: ${response.statusText}</div>`;

                if (response.ok) {
                    const data = await response.json();
                    html += `<div class="status-box status-good">âœ… èµ„æºåˆ—è¡¨APIè®¿é—®æˆåŠŸ</div>`;
                    html += `<div class="code-display">å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}</div>`;
                    
                    if (data.resources && data.resources.length > 0) {
                        const firstResource = data.resources[0];
                        html += `<div class="status-box status-info">â„¹ï¸ æ‰¾åˆ° ${data.resources.length} ä¸ªèµ„æºï¼Œç¬¬ä¸€ä¸ªèµ„æºID: ${firstResource.id}</div>`;
                        
                        // è‡ªåŠ¨æµ‹è¯•ç¬¬ä¸€ä¸ªèµ„æºçš„è¯¦æƒ…
                        setTimeout(() => testSpecificResourceDetail(firstResource.id), 1000);
                    }
                } else {
                    const errorText = await response.text();
                    html += `<div class="status-box status-error">âŒ èµ„æºåˆ—è¡¨APIè®¿é—®å¤±è´¥</div>`;
                    html += `<div class="code-display">é”™è¯¯ä¿¡æ¯: ${errorText}</div>`;
                }

                addResult('api-test-results', html, 'info');
            } catch (error) {
                console.error('æµ‹è¯•èµ„æºåˆ—è¡¨APIå¤±è´¥:', error);
                addResult('api-test-results', `âŒ æµ‹è¯•èµ„æºåˆ—è¡¨APIå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testSpecificResourceDetail(resourceId) {
            console.log(`æµ‹è¯•èµ„æºè¯¦æƒ…APIï¼Œèµ„æºID: ${resourceId}`);
            try {
                const authStorage = localStorage.getItem('auth-storage');
                const parsed = JSON.parse(authStorage);
                const token = (parsed.state || parsed).token;

                const response = await fetch(`/api/resources/${resourceId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let html = `<h4>ğŸ“„ èµ„æºè¯¦æƒ…APIæµ‹è¯• (ID: ${resourceId})</h4>`;
                html += `<div class="code-display">è¯·æ±‚URL: /api/resources/${resourceId}
å“åº”çŠ¶æ€: ${response.status}
å“åº”çŠ¶æ€æ–‡æœ¬: ${response.statusText}</div>`;

                if (response.ok) {
                    const data = await response.json();
                    html += `<div class="status-box status-good">âœ… èµ„æºè¯¦æƒ…APIè®¿é—®æˆåŠŸ</div>`;
                    html += `<div class="code-display">èµ„æºæ ‡é¢˜: ${data.title}
èµ„æºåˆ†ç±»: ${data.category?.name}
åˆ›å»ºæ—¶é—´: ${data.createdAt}</div>`;
                } else {
                    const errorText = await response.text();
                    html += `<div class="status-box status-error">âŒ èµ„æºè¯¦æƒ…APIè®¿é—®å¤±è´¥</div>`;
                    html += `<div class="code-display">é”™è¯¯ä¿¡æ¯: ${errorText}</div>`;
                }

                addResult('api-test-results', html, 'info');
            } catch (error) {
                console.error('æµ‹è¯•èµ„æºè¯¦æƒ…APIå¤±è´¥:', error);
                addResult('api-test-results', `âŒ æµ‹è¯•èµ„æºè¯¦æƒ…APIå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testResourceDetailAPI() {
            console.log('æµ‹è¯•èµ„æºè¯¦æƒ…API...');
            const resourceId = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„èµ„æºIDï¼ˆç•™ç©ºåˆ™ä½¿ç”¨ID 1ï¼‰:') || '1';
            await testSpecificResourceDetail(resourceId);
        }

        async function testUserProfileAPI() {
            console.log('æµ‹è¯•ç”¨æˆ·èµ„æ–™API...');
            try {
                const authStorage = localStorage.getItem('auth-storage');
                if (!authStorage) {
                    addResult('api-test-results', 'âŒ æ— æ³•æµ‹è¯•APIï¼šè®¤è¯å­˜å‚¨ä¸å­˜åœ¨', 'error');
                    return;
                }

                const parsed = JSON.parse(authStorage);
                const token = (parsed.state || parsed).token;
                
                if (!token) {
                    addResult('api-test-results', 'âŒ æ— æ³•æµ‹è¯•APIï¼šTokenä¸å­˜åœ¨', 'error');
                    return;
                }

                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let html = '<h4>ğŸ‘¤ ç”¨æˆ·èµ„æ–™APIæµ‹è¯•</h4>';
                html += `<div class="code-display">è¯·æ±‚URL: /api/auth/profile
å“åº”çŠ¶æ€: ${response.status}
å“åº”çŠ¶æ€æ–‡æœ¬: ${response.statusText}</div>`;

                if (response.ok) {
                    const data = await response.json();
                    html += `<div class="status-box status-good">âœ… ç”¨æˆ·èµ„æ–™APIè®¿é—®æˆåŠŸ</div>`;
                    html += `<div class="code-display">ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(data, null, 2)}</div>`;
                    
                    if (data.role === 'LIFETIME') {
                        html += '<div class="status-box status-good">âœ… APIç¡®è®¤ï¼šç”¨æˆ·è§’è‰²ä¸ºLIFETIME</div>';
                    } else {
                        html += `<div class="status-box status-warning">âš ï¸ APIè¿”å›è§’è‰²: ${data.role}</div>`;
                    }
                } else {
                    const errorText = await response.text();
                    html += `<div class="status-box status-error">âŒ ç”¨æˆ·èµ„æ–™APIè®¿é—®å¤±è´¥</div>`;
                    html += `<div class="code-display">é”™è¯¯ä¿¡æ¯: ${errorText}</div>`;
                }

                addResult('api-test-results', html, 'info');
            } catch (error) {
                console.error('æµ‹è¯•ç”¨æˆ·èµ„æ–™APIå¤±è´¥:', error);
                addResult('api-test-results', `âŒ æµ‹è¯•ç”¨æˆ·èµ„æ–™APIå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function startRealTimeMonitoring() {
            console.log('å¼€å§‹å®æ—¶ç›‘æ§...');
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            addResult('monitoring-results', 'ğŸ”„ å¼€å§‹å®æ—¶ç›‘æ§è®¤è¯çŠ¶æ€...', 'info');

            monitoringInterval = setInterval(() => {
                const authStorage = localStorage.getItem('auth-storage');
                let status = 'æœªç™»å½•';
                let role = 'N/A';
                let isAuthenticated = false;

                if (authStorage) {
                    try {
                        const parsed = JSON.parse(authStorage);
                        const state = parsed.state || parsed;
                        if (state.user) {
                            status = 'å·²ç™»å½•';
                            role = state.user.role;
                            isAuthenticated = state.isAuthenticated;
                        }
                    } catch (e) {
                        status = 'è§£æé”™è¯¯';
                    }
                }

                const timestamp = new Date().toLocaleTimeString();
                const html = `<div class="status-box status-info">
                    <strong>å®æ—¶çŠ¶æ€</strong> (${timestamp})<br>
                    ç™»å½•çŠ¶æ€: ${status}<br>
                    è®¤è¯çŠ¶æ€: ${isAuthenticated ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}<br>
                    ç”¨æˆ·è§’è‰²: ${role}
                </div>`;

                const container = document.getElementById('monitoring-results');
                const existingMonitor = container.querySelector('.real-time-status');
                if (existingMonitor) {
                    existingMonitor.innerHTML = html;
                } else {
                    const monitorDiv = document.createElement('div');
                    monitorDiv.className = 'real-time-status';
                    monitorDiv.innerHTML = html;
                    container.appendChild(monitorDiv);
                }
            }, 2000);
        }

        function stopRealTimeMonitoring() {
            console.log('åœæ­¢å®æ—¶ç›‘æ§...');
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            addResult('monitoring-results', 'â¹ï¸ å®æ—¶ç›‘æ§å·²åœæ­¢', 'warning');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹åŸºç¡€æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŸºç¡€æ£€æŸ¥...');
            setTimeout(() => {
                checkAuthStorage();
                checkUserState();
            }, 1000);
        });
    </script>
</body>
</html> 